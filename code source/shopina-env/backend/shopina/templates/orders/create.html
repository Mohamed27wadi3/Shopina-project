{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cr√©er une commande | Shopina</title>
  <style>
    :root { --bg:#0b1220; --panel:#0f172a; --text:#e2e8f0; --muted:#94a3b8; --border: rgba(148,163,184,0.16); --accent:#3b82f6; --radius:14px; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 920px; margin: 0 auto; padding: 24px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 14px; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; text-decoration:none; font-weight:700; border:1px solid rgba(148,163,184,0.2); background: rgba(15,23,42,0.8); color: var(--text); }
    .btn:hover { transform: translateY(-1px); border-color: rgba(59,130,246,0.4); }
    h1 { margin:0; font-size: 24px; }
    form { background: var(--panel); border:1px solid var(--border); border-radius: var(--radius); padding: 16px; display:grid; gap:14px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-weight:700; font-size:14px; }
    select, input, textarea { width:100%; padding:10px 12px; border-radius: 12px; border:1px solid var(--border); background:#0f1526; color: var(--text); }
    .actions { display:flex; gap:10px; justify-content:flex-end; }
    .primary { background: linear-gradient(135deg,#3b82f6,#22d3ee); color:#fff; border:none; }
    .primary:hover { filter: brightness(1.05); }
    .header-menu { display:flex; align-items:center; gap:10px; }
    .header-menu-button { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; background: rgba(59,130,246,0.15); border:1px solid rgba(59,130,246,0.3); color:#e2e8f0; text-decoration:none; cursor:pointer; font-weight:600; font-size:13px; transition:all 300ms ease; }
    .header-menu-button:hover { background: rgba(59,130,246,0.25); border-color: rgba(59,130,246,0.6); transform: translateY(-2px); }
    .header-menu-button.home { background: linear-gradient(135deg,#3b82f6,#22d3ee); border-color: #3b82f6; color:#fff; }
    .header-menu-button.home:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
    .profile-section { position:relative; display:flex; align-items:center; gap:10px; }
    .profile-trigger { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; border:1px solid transparent; background:transparent; color: var(--text); cursor:pointer; transition: all 200ms ease; }
    .profile-trigger:hover { border-color: var(--border); background: rgba(59,130,246,0.08); }
    .profile-trigger:focus-visible { outline:2px solid rgba(59,130,246,0.5); outline-offset:3px; }
    .profile-avatar { width:36px; height:36px; border-radius:50%; background: linear-gradient(135deg,#3b82f6,#22d3ee); display:flex; align-items:center; justify-content:center; font-weight:800; color:#fff; }
    .profile-avatar img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
    .profile-info { line-height:1.2; text-align:left; }
    .profile-name { margin:0; font-size:13px; font-weight:700; color: var(--text); }
    .profile-role { margin:2px 0 0; font-size:11px; font-weight:600; color: var(--accent); }
    .profile-chevron { font-size:12px; color: var(--muted); }
    .profile-menu { position:absolute; right:0; top:calc(100% + 8px); min-width: 220px; background: var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:0 20px 48px rgba(0,0,0,0.26); padding:8px; display:none; flex-direction:column; gap:4px; z-index:30; }
    .profile-menu.open { display:flex; animation: fadeDown 160ms ease; }
    .profile-menu a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; color: var(--text); text-decoration:none; font-weight:600; transition: all 180ms ease; }
    .profile-menu a:hover, .profile-menu a:focus-visible { background: rgba(59,130,246,0.14); color: var(--accent-bright); outline:none; }
    .profile-menu .danger { color:#fca5a5; }
    .profile-menu .danger:hover, .profile-menu .danger:focus-visible { background: rgba(248,113,113,0.15); }
    .breadcrumb { display:flex; align-items:center; gap:8px; padding:12px 0; margin-bottom:16px; font-size:13px; color:#94a3b8; border-bottom:1px solid rgba(148,163,184,0.16); }
    .breadcrumb a { color:#3b82f6; text-decoration:none; transition:all 200ms ease; }
    .breadcrumb a:hover { color:#22d3ee; text-decoration:underline; }
    .breadcrumb-separator { color:#64748b; margin:0 4px; }
    .breadcrumb-current { color:#e2e8f0; font-weight:600; }
    .summary { display:flex; align-items:center; justify-content:space-between; background: rgba(59,130,246,0.12); border:1px solid rgba(59,130,246,0.3); padding:12px; border-radius:12px; }
    .muted { color: var(--muted); font-size: 12px; }
    @keyframes fadeDown { from { opacity:0; transform: translateY(-4px); } to { opacity:1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" style="gap:12px;">
      <div class="header-menu">
        <a href="{% url 'home' %}" class="header-menu-button" title="Page d'accueil publique">Accueil</a>
        <a href="/dashboard/" class="header-menu-button home" title="Tableau de bord">üìä Dashboard</a>
      </div>
      <a href="{% url 'dashboard' %}" class="btn">‚Üê Tableau de bord</a>
      <a href="{% url 'orders-page' %}" class="btn">üìÑ Liste des commandes</a>
      <div style="margin-left:auto; display:flex; align-items:center; gap:12px;" data-profile-menu>
        <button class="profile-trigger" type="button" aria-haspopup="menu" aria-expanded="false">
          <span class="profile-avatar">
            {% if request.user.is_authenticated and request.user.avatar %}
              <img src="{{ request.user.avatar.url }}" alt="Avatar" />
            {% else %}
              {% if request.user.is_authenticated %}
                {{ request.user.username|first|upper }}
              {% else %}
                G
              {% endif %}
            {% endif %}
          </span>
          <span class="profile-info">
            {% if request.user.is_authenticated %}
              <span class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
              <span class="profile-role">{% if request.user.is_staff %}Admin{% elif request.user.is_superuser %}Propri√©taire{% else %}Utilisateur{% endif %}</span>
            {% else %}
              <span class="profile-name">Invit√©</span>
              <span class="profile-role">Public</span>
            {% endif %}
          </span>
          <span class="profile-chevron" aria-hidden="true">‚ñæ</span>
        </button>
        <div class="profile-menu" role="menu">
          <a href="{% url 'profile_dynamic' %}" role="menuitem">üë§ Profil</a>
          <a href="/accounts/password_change/" role="menuitem">‚öôÔ∏è Param√®tres</a>
          <a href="{% url 'home' %}" role="menuitem">üëÄ Vue visiteur</a>
          <a href="{% url 'orders-page' %}" role="menuitem">üì¶ Commandes</a>
          <a href="/accounts/logout/" role="menuitem" class="danger">üö™ D√©connexion</a>
        </div>
      </div>
    </div>
    
    <nav class="breadcrumb" aria-label="Fil d'Ariane">
      <a href="/dashboard/">üìä Tableau de bord</a>
      <span class="breadcrumb-separator">/</span>
      <a href="/orders/">üì¶ Commandes</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current">‚ûï Cr√©er commande</span>
    </nav>

    <h1>Cr√©er une commande</h1>
    <p class="muted">S√©lectionnez un client, un produit et d√©finissez les quantit√©s et le prix. Le total se calcule automatiquement.</p>

    <form method="post">
      {% csrf_token %}
      <div class="row">
        <div>
          <label for="user_id">Client</label>
          <select id="user_id" name="user_id" required>
            <option value="" disabled selected>Choisir un client‚Ä¶</option>
            {% for u in users %}
              <option value="{{ u.id }}">{{ u.get_full_name|default:u.username }} ({{ u.email }})</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="status">Statut</label>
          <select id="status" name="status">
            <option value="processing">En cours</option>
            <option value="completed">Termin√©e</option>
            <option value="pending">En attente</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="product_id">Produit</label>
          <select id="product_id" name="product_id" required>
            <option value="" disabled selected>Choisir un produit‚Ä¶</option>
            {% for p in products %}
              <option data-price="{{ p.price }}" value="{{ p.id }}">{{ p.name }} ‚Äî {{ p.price }} DA</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="quantity">Quantit√©</label>
          <input type="number" id="quantity" name="quantity" value="1" min="1" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="price">Prix unitaire (DA)</label>
          <input type="number" id="price" name="price" value="0" min="0" step="0.01" required />
        </div>
        <div>
          <label for="total">Total (DA)</label>
          <input type="number" id="total" name="total" value="0" min="0" step="0.01" readonly />
        </div>
      </div>

      <div class="summary">
        <div>üí∞ Total calcul√©: <strong id="totalLabel">0</strong> DA</div>
        <div class="muted">Le total sera enregistr√© √† la validation.</div>
      </div>

      <div class="actions">
        <a href="{% url 'dashboard' %}" class="btn">Annuler</a>
        <button type="submit" class="btn primary">Enregistrer la commande</button>
      </div>
    </form>
  </div>

  <script>
    const product = document.getElementById('product_id');
    const qty = document.getElementById('quantity');
    const price = document.getElementById('price');
    const total = document.getElementById('total');
    const totalLabel = document.getElementById('totalLabel');

    function recalc() {
      const q = parseFloat(qty.value || '0');
      const p = parseFloat(price.value || '0');
      const t = Math.max(0, q * p);
      total.value = t.toFixed(2);
      totalLabel.textContent = t.toFixed(2);
    }
    product?.addEventListener('change', () => {
      const sel = product.options[product.selectedIndex];
      const p = sel ? sel.getAttribute('data-price') : '0';
      if (p) price.value = p;
      recalc();
    });
    qty.addEventListener('input', recalc);
    price.addEventListener('input', recalc);
    recalc();
  </script>
  <script>
    (function() {
      const containers = document.querySelectorAll('[data-profile-menu]');
      containers.forEach(container => {
        const trigger = container.querySelector('.profile-trigger');
        const menu = container.querySelector('.profile-menu');
        if (!trigger || !menu) return;
        const items = Array.from(menu.querySelectorAll('[role="menuitem"]'));
        const close = () => { menu.classList.remove('open'); trigger.setAttribute('aria-expanded','false'); };
        const open = () => { menu.classList.add('open'); trigger.setAttribute('aria-expanded','true'); };
        const toggle = () => menu.classList.contains('open') ? close() : open();
        trigger.addEventListener('click', (e) => { e.stopPropagation(); toggle(); if (menu.classList.contains('open') && items.length) items[0].focus(); });
        trigger.addEventListener('keydown', (e) => { if (['Enter',' ','ArrowDown'].includes(e.key)) { e.preventDefault(); open(); if (items.length) items[0].focus(); } });
        menu.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') { close(); trigger.focus(); }
          if (['ArrowDown','ArrowUp'].includes(e.key)) { e.preventDefault(); const current = items.indexOf(document.activeElement); const dir = e.key === 'ArrowDown' ? 1 : -1; const next = (current + dir + items.length) % items.length; items[next]?.focus(); }
        });
        document.addEventListener('click', (e) => { if (!container.contains(e.target)) close(); });
      });
    })();
  </script>
</body>
</html>
