<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres - {{ page_title }} - Shopina</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
            font-family: -apple-system, 'Segoe UI', 'Roboto', sans-serif;
            color: #0A1A2F;
            min-height: 100vh;
        }

        .navbar {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 30;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 24px;
        }

        .navbar-brand {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #0077FF 0%, #5AC8FA 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
            letter-spacing: -0.5px;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0077FF 0%, #5AC8FA 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 119, 255, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 119, 255, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #0A1A2F;
            border: 1.5px solid #e0e0e0;
        }

        .btn-secondary:hover {
            border-color: #0077FF;
            background: #f8f9fa;
        }

        .profile-header { 
            position: relative; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        .profile-trigger { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 8px 12px; 
            border-radius: 12px; 
            border: 1.5px solid transparent; 
            background: transparent; 
            cursor: pointer; 
            transition: all 200ms ease; 
        }

        .profile-trigger:hover { 
            border-color: #e0e0e0; 
            background: #f3f7ff; 
        }

        .profile-avatar { 
            width: 38px; 
            height: 38px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #0077FF, #5AC8FA); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 800; 
            color: #fff; 
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 119, 255, 0.2);
        }

        .profile-avatar img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 50%; 
        }

        .profile-info { 
            line-height: 1.3; 
            font-size: 13px; 
            text-align: left; 
        }

        .profile-name { 
            font-weight: 700; 
            color: #0A1A2F; 
            margin: 0; 
        }

        .profile-role { 
            font-size: 11px; 
            color: #0077FF; 
            font-weight: 600;
        }

        .profile-chevron { 
            font-size: 12px; 
            color: #8a9ab3; 
            transition: transform 200ms ease;
        }

        .profile-trigger[aria-expanded="true"] .profile-chevron {
            transform: scaleY(-1);
        }

        .profile-menu { 
            position: absolute; 
            right: 0; 
            top: calc(100% + 8px); 
            min-width: 240px; 
            background: white; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(10, 26, 47, 0.15); 
            padding: 8px; 
            display: none; 
            flex-direction: column; 
            gap: 4px; 
            z-index: 50; 
        }

        .profile-menu.open { 
            display: flex; 
            animation: slideDown 200ms cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .profile-menu a { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 11px 14px; 
            border-radius: 10px; 
            color: #0A1A2F; 
            text-decoration: none; 
            font-weight: 500; 
            transition: all 180ms ease; 
            font-size: 13px;
        }

        .profile-menu a:hover, 
        .profile-menu a:focus-visible { 
            background: #f3f7ff; 
            color: #0077FF;
            outline: none; 
        }

        .profile-menu .danger { 
            color: #d62f2f; 
        }

        .profile-menu .danger:hover { 
            background: rgba(214, 47, 47, 0.08); 
            color: #d62f2f;
        }

        @keyframes slideDown { 
            from { 
                opacity: 0; 
                transform: translateY(-8px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 48px 24px;
        }

        .header-section {
            margin-bottom: 40px;
        }

        .header-title {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 8px;
            color: #0A1A2F;
            letter-spacing: -0.5px;
        }

        .header-desc {
            font-size: 15px;
            color: #666;
            font-weight: 500;
        }

        /* Tab Navigation */
        .tabs-nav {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 14px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: #0077FF;
        }

        .tab-btn.active {
            color: #0077FF;
            border-bottom-color: #0077FF;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 300ms ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
            border: 1px solid #f0f0f0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 28px;
            color: #0A1A2F;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-divider {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 28px;
            margin-bottom: 28px;
        }

        .form-group {
            margin-bottom: 26px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            color: #0A1A2F;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }

        label .required {
            color: #ff4757;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0077FF;
            box-shadow: 0 0 0 4px rgba(0, 119, 255, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 140px;
        }

        .form-help {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
            display: block;
        }

        .error-message {
            color: #ff4757;
            font-size: 12px;
            margin-top: 6px;
            display: block;
            font-weight: 500;
        }

        /* File Upload */
        .file-input-wrapper {
            position: relative;
        }

        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .file-input-label:hover {
            border-color: #0077FF;
            background: #f0f5ff;
        }

        .file-input-label.active {
            border-color: #0077FF;
            background: #e8f2ff;
        }

        .file-input-label-text {
            font-size: 14px;
            font-weight: 600;
            color: #0077FF;
            margin-top: 10px;
        }

        .file-input-label-icon {
            font-size: 40px;
        }

        input[type="file"] {
            display: none;
        }

        .preview-box {
            margin-top: 14px;
            padding: 14px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
            border-radius: 10px;
            text-align: center;
        }

        .preview-img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .preview-filename {
            font-size: 12px;
            color: #666;
            word-break: break-all;
            font-weight: 500;
        }

        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            position: relative;
        }

        .template-card:hover {
            border-color: #0077FF;
            box-shadow: 0 8px 24px rgba(0, 119, 255, 0.15);
            transform: translateY(-4px);
        }

        .template-card.selected {
            border-color: #0077FF;
            background: linear-gradient(135deg, #e8f2ff 0%, #f0f7ff 100%);
        }

        .template-preview {
            aspect-ratio: 3/2;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #999;
            overflow: hidden;
        }

        .template-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .template-info {
            padding: 16px;
        }

        .template-name {
            font-weight: 700;
            color: #0A1A2F;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .template-category {
            font-size: 12px;
            color: #999;
        }

        .template-check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #0077FF;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 119, 255, 0.3);
        }

        .template-card.selected .template-check {
            display: flex;
        }

        /* Button Group */
        .button-group {
            display: flex;
            gap: 14px;
            margin-top: 40px;
            padding-top: 28px;
            border-top: 1px solid #f0f0f0;
        }

        button[type="submit"],
        .btn-submit {
            flex: 1;
            padding: 14px 28px;
            background: linear-gradient(135deg, #0077FF 0%, #5AC8FA 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 119, 255, 0.2);
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 119, 255, 0.3);
        }

        button[type="submit"]:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-cancel {
            background: white !important;
            color: #0A1A2F !important;
            border: 1.5px solid #e0e0e0;
            box-shadow: none !important;
        }

        .btn-cancel:hover {
            background: #f5f7fa !important;
            border-color: #0077FF;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert Boxes */
        .alert {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .alert-success {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%);
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .alert-error {
            background: linear-gradient(135deg, #ffebee 0%, #fff5f5 100%);
            border-left: 4px solid #d32f2f;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .container {
                padding: 32px 16px;
            }

            .header-title {
                font-size: 28px;
            }

            .section {
                padding: 24px;
            }

            .section-divider {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 14px;
            }

            .button-group {
                flex-direction: column;
                gap: 10px;
            }

            button[type="submit"],
            .btn-submit,
            .btn-cancel {
                width: 100%;
            }

            .tabs-nav {
                gap: 0;
                margin-bottom: 24px;
            }

            .tab-btn {
                flex: 1;
                text-align: center;
                padding: 12px 16px;
                font-size: 14px;
            }

            .navbar-actions {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="navbar-content">
            <a href="http://localhost:3000/" class="navbar-brand">Shopina</a>
            <div class="navbar-actions">
                <div style="display:flex; align-items:center; gap:10px;">
                    <a href="{% url 'home' %}" class="btn btn-secondary" style="background: rgba(0,119,255,0.1); border:1px solid rgba(0,119,255,0.3);">Accueil</a>
                    <a href="/dashboard/" class="btn btn-primary">üìä Dashboard</a>
                </div>
                <a href="/shop/{% if shop %}{{ shop.slug }}/dashboard/{% endif %}" class="btn btn-secondary">‚Üê Retour</a>
                <div class="profile-header" data-profile-menu>
                    <button class="profile-trigger" type="button" aria-haspopup="menu" aria-expanded="false">
                        <span class="profile-avatar">
                            {% if request.user.is_authenticated and request.user.avatar %}
                                <img src="{{ request.user.avatar.url }}" alt="Avatar" />
                            {% else %}
                                {% if request.user.is_authenticated %}
                                    {{ request.user.username|first|upper }}
                                {% else %}
                                    G
                                {% endif %}
                            {% endif %}
                        </span>
                        <span class="profile-info">
                            {% if request.user.is_authenticated %}
                                <span class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                                <span class="profile-role">{% if request.user.is_staff %}Admin{% elif request.user.is_superuser %}Propri√©taire{% else %}Utilisateur{% endif %}</span>
                            {% else %}
                                <span class="profile-name">Invit√©</span>
                                <span class="profile-role">Public</span>
                            {% endif %}
                        </span>
                        <span class="profile-chevron" aria-hidden="true">‚ñæ</span>
                    </button>
                    <div class="profile-menu" role="menu">
                        <a href="{% url 'profile_dynamic' %}" role="menuitem">üë§ Profil</a>
                        <a href="/accounts/password_change/" role="menuitem">‚öôÔ∏è Param√®tres</a>
                        <a href="{% url 'home' %}" role="menuitem">üëÄ Vue visiteur</a>
                        <a href="{% url 'orders-page' %}" role="menuitem">üì¶ Commandes</a>
                        <a href="/accounts/logout/" role="menuitem" class="danger">üö™ D√©connexion</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Header Section -->
        <div class="header-section">
            <h1 class="header-title">‚öôÔ∏è Param√®tres de la boutique</h1>
            <p class="header-desc">G√©rez les informations, le branding et l'apparence de votre boutique</p>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
                    <span class="alert-icon">{% if message.tags == 'success' %}‚úÖ{% else %}‚ùå{% endif %}</span>
                    <div>{{ message }}</div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Tab Navigation -->
        <div class="tabs-nav">
            <button type="button" class="tab-btn active" data-tab="info">üìù Informations</button>
            <button type="button" class="tab-btn" data-tab="contact">üìû Contact</button>
            <button type="button" class="tab-btn" data-tab="branding">üé® Branding</button>
            <button type="button" class="tab-btn" data-tab="template">üé≠ Template</button>
        </div>

        <!-- Update Form -->
        <form method="post" enctype="multipart/form-data" id="updateForm">
            {% csrf_token %}

            <!-- Tab: Information -->
            <div id="info" class="tab-content active">
                <div class="section">
                    <h2 class="section-title">üìù Informations g√©n√©rales</h2>

                    <div class="form-group">
                        <label for="id_name">Nom de la boutique <span class="required">*</span></label>
                        {% if form.name.errors %}
                            {% for error in form.name.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                        {{ form.name }}
                        <span class="form-help">Le nom public de votre boutique</span>
                    </div>

                    <div class="form-group">
                        <label for="id_description">Description</label>
                        {% if form.description.errors %}
                            {% for error in form.description.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                        {{ form.description }}
                        <span class="form-help">D√©crivez votre boutique, ses produits et vos services</span>
                    </div>
                </div>
            </div>

            <!-- Tab: Contact -->
            <div id="contact" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üìû Informations de contact</h2>

                    <div class="section-divider">
                        <div class="form-group">
                            <label for="id_email">Email de contact</label>
                            {% if form.email.errors %}
                                {% for error in form.email.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                            {{ form.email }}
                            <span class="form-help">Email visible pour les clients</span>
                        </div>

                        <div class="form-group">
                            <label for="id_phone">T√©l√©phone</label>
                            {% if form.phone.errors %}
                                {% for error in form.phone.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                            {{ form.phone }}
                            <span class="form-help">Num√©ro de t√©l√©phone de votre boutique</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="id_address">Adresse</label>
                        {% if form.address.errors %}
                            {% for error in form.address.errors %}
                                <span class="error-message">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                        {{ form.address }}
                        <span class="form-help">Adresse physique de votre boutique</span>
                    </div>

                    <div class="section-divider">
                        <div class="form-group">
                            <label for="id_city">Ville</label>
                            {% if form.city.errors %}
                                {% for error in form.city.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                            {{ form.city }}
                        </div>

                        <div class="form-group">
                            <label for="id_country">Pays</label>
                            {% if form.country.errors %}
                                {% for error in form.country.errors %}
                                    <span class="error-message">{{ error }}</span>
                                {% endfor %}
                            {% endif %}
                            {{ form.country }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Branding -->
            <div id="branding" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üé® Logo et banni√®re</h2>

                    <div class="section-divider">
                        <div class="form-group">
                            <label for="id_logo">Logo de la boutique</label>
                            <div class="file-input-wrapper">
                                <label for="id_logo" class="file-input-label">
                                    <span class="file-input-label-icon">üì∑</span>
                                    <span class="file-input-label-text">Cliquez pour choisir</span>
                                </label>
                                {{ form.logo }}
                                <span class="form-help">JPG, PNG, WebP ‚Ä¢ Max 5MB</span>
                            </div>
                            {% if shop.logo %}
                                <div class="preview-box">
                                    <img src="{{ shop.logo.url }}" alt="Logo actuel" class="preview-img" style="max-height: 100px;">
                                    <div class="preview-filename">Logo actuel</div>
                                </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="id_banner">Banni√®re de la boutique</label>
                            <div class="file-input-wrapper">
                                <label for="id_banner" class="file-input-label">
                                    <span class="file-input-label-icon">üñºÔ∏è</span>
                                    <span class="file-input-label-text">Cliquez pour choisir</span>
                                </label>
                                {{ form.banner }}
                                <span class="form-help">JPG, PNG, WebP ‚Ä¢ Max 10MB</span>
                            </div>
                            {% if shop.banner %}
                                <div class="preview-box">
                                    <img src="{{ shop.banner.url }}" alt="Banni√®re actuelle" class="preview-img" style="max-height: 150px;">
                                    <div class="preview-filename">Banni√®re actuelle</div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Template -->
            <div id="template" class="tab-content">
                <div class="section">
                    <h2 class="section-title">üé≠ Choisir un template</h2>
                    <p style="color: #666; margin-bottom: 20px; font-size: 14px;">S√©lectionnez un template pour personnaliser l'apparence de votre boutique</p>

                    <div class="template-grid" id="templateGrid">
                        <div style="padding: 24px; text-align: center; color: #999;">Chargement des templates...</div>
                    </div>

                    <div class="form-help" style="margin-top: 20px; padding: 12px; background: #f0f0f0; border-radius: 8px;">
                        üí° Consultez plus de templates et pr√©visualisez-les sur la <a href="/templates/" style="color: #0077FF; text-decoration: none; font-weight: 600;">page des templates</a>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <a href="/shop/{% if shop %}{{ shop.slug }}/dashboard/{% endif %}" class="btn btn-cancel">Annuler</a>
                <button type="submit" id="submitBtn">
                    <span id="buttonText">üíæ Enregistrer les modifications</span>
                    <span class="loading" id="loading">
                        <span class="spinner"></span>
                        Enregistrement...
                    </span>
                </button>
            </div>
        </form>
    </div>

    <script>
        // Tab switching
        const tabBtns = document.querySelectorAll('[data-tab]');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Remove active from all tabs and contents
                tabBtns.forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab and corresponding content
                btn.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // File upload preview
        ['id_logo', 'id_banner'].forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.createElement('div');
                    preview.className = 'preview-box';
                    preview.innerHTML = `
                        <img src="${event.target.result}" alt="Preview" class="preview-img">
                        <div class="preview-filename">${file.name}</div>
                    `;
                    
                    // Remove old preview
                    const oldPreview = input.parentElement.querySelector('.preview-box');
                    if (oldPreview) oldPreview.remove();
                    
                    input.parentElement.appendChild(preview);
                };
                reader.readAsDataURL(file);
            });
        });

        // Form submission
        document.getElementById('updateForm').addEventListener('submit', function() {
            document.getElementById('buttonText').style.display = 'none';
            document.getElementById('loading').classList.add('active');
            document.getElementById('submitBtn').disabled = true;
        });

        // Load templates
        async function loadTemplates() {
            const grid = document.getElementById('templateGrid');
            try {
                const res = await fetch('/api/templates/');
                const templates = await res.json();
                
                if (!Array.isArray(templates) || templates.length === 0) {
                    grid.innerHTML = '<div style="padding: 24px; text-align: center; color: #999; grid-column: 1/-1;">Aucun template disponible</div>';
                    return;
                }
                
                grid.innerHTML = templates.map(t => `
                    <div class="template-card" style="position: relative; cursor: pointer;">
                        <div class="template-preview">
                            ${t.image ? `<img src="${t.image}" alt="${t.title}">` : t.title}
                        </div>
                        <div class="template-info">
                            <div class="template-name">${t.title}</div>
                            <div class="template-category">${t.category || 'Standard'}</div>
                        </div>
                        <div class="template-check">‚úì</div>
                    </div>
                `).join('');
            } catch (err) {
                grid.innerHTML = '<div style="padding: 24px; text-align: center; color: #d32f2f; grid-column: 1/-1;">Erreur lors du chargement des templates</div>';
                console.error(err);
            }
        }

        window.addEventListener('load', loadTemplates);

        // Profile menu
        (function() {
            const containers = document.querySelectorAll('[data-profile-menu]');
            containers.forEach(container => {
                const trigger = container.querySelector('.profile-trigger');
                const menu = container.querySelector('.profile-menu');
                if (!trigger || !menu) return;
                const items = Array.from(menu.querySelectorAll('[role="menuitem"]'));
                const close = () => { menu.classList.remove('open'); trigger.setAttribute('aria-expanded','false'); };
                const open = () => { menu.classList.add('open'); trigger.setAttribute('aria-expanded','true'); };
                const toggle = () => menu.classList.contains('open') ? close() : open();
                trigger.addEventListener('click', (e) => { e.stopPropagation(); toggle(); if (menu.classList.contains('open') && items.length) items[0].focus(); });
                trigger.addEventListener('keydown', (e) => { if (['Enter',' ','ArrowDown'].includes(e.key)) { e.preventDefault(); open(); if (items.length) items[0].focus(); } });
                menu.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') { close(); trigger.focus(); }
                    if (['ArrowDown','ArrowUp'].includes(e.key)) { e.preventDefault(); const current = items.indexOf(document.activeElement); const dir = e.key === 'ArrowDown' ? 1 : -1; const next = (current + dir + items.length) % items.length; items[next]?.focus(); }
                });
                document.addEventListener('click', (e) => { if (!container.contains(e.target)) close(); });
            });
        })();
    </script>
</body>
</html>
